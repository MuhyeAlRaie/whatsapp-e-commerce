<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>متجر إلكتروني بسيط</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
<style>
   
    .hero {
      background: url('assets/img/banner/banner01.jpg') center/cover no-repeat;
      color: white;
      text-align: center;
      padding: 100px 20px;
    }
    .product-card img {
      height: 200px;
      object-fit: cover;
    }
     .product-popup, .checkout-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1050;
      width: 400px;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
     .cart-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding-top: 70px;
      padding-left: 15px;
      padding-right: 15px;
      padding-bottom: 15px;
      z-index: 1000;
      width: 300px;
      display: none;
    }
    .filter-buttons .btn {
      margin-left: 10px;
    }
    .product-popup img {
      width: 100%;
      height: auto;
      margin-bottom: 10px;
    }
    #map {
      height: 300px;
      width: 100%;
      margin-bottom: 10px;
    }
    #location-error {
      color: red;
      font-size: 0.9em;
      margin-top: -10px;
      margin-bottom: 10px;
      display: none;
    }
  #popup-carousel img {
    height: 250px;
    object-fit: cover;
    border-radius: 8px;
  }
  #popup-thumbnails img {
    height: 60px;
    object-fit: cover;
    border: 2px solid transparent;
  }
  #popup-thumbnails img:hover {
    border-color: #007bff;
  }
  </style>
</head>
<body>
<!-- الهيدر -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
<div class="container">
<a class="navbar-brand" href="#"><img alt="الشعار" src="assets/img/logo.png" style="max-width: 150px;"/></a>
<div class="me-auto">
<button class="btn btn-outline-primary" onclick="toggleCartPopup()">
        🛒 <span id="cart-count">0</span>
</button>
</div>
</div>
</nav>
<!-- البانر -->
<section class="hero">
<h1>مرحباً بكم في متجرنا</h1>
<p>اكتشف منتجاتنا المميزة</p>
</section>
<!-- الفلاتر -->
<div class="container my-4 d-flex align-items-center justify-content-end">
<input class="form-control w-25 ms-3" id="searchInput" oninput="displayProducts()" placeholder="ابحث عن منتج..." type="text"/>
<div class="filter-buttons">
<button class="btn btn-outline-dark" onclick="setFilter('all')">الكل</button>
<button class="btn btn-outline-dark" onclick="setFilter('electronics')">إلكترونيات</button>
<button class="btn btn-outline-dark" onclick="setFilter('fashion')">ملابس</button>
</div>
</div>
<!-- المنتجات -->
<div class="container">
<div class="row g-4" id="products"></div>
</div>
<!-- السلة -->
<div class="cart-popup" id="cart-popup">
<h5>سلة المشتريات</h5>
<ul class="list-group mb-2" id="cart-items" style="max-height: 250px; overflow-y: auto;"></ul>
<div class="d-flex justify-content-between fw-bold mb-2">
<span>الإجمالي:</span>
<span id="cart-total">0 د.أ</span>
</div>
<button class="btn btn-success w-100" onclick="showCheckoutPopup()">إتمام الشراء</button>
</div>
<!-- تفاصيل المنتج -->
<div class="product-popup" id="product-popup">
<h5 id="popup-title"></h5>
<div class="carousel slide mb-3" data-bs-ride="carousel" id="popup-carousel">
<div class="carousel-inner" id="popup-carousel-inner"></div>
<button class="carousel-control-prev" data-bs-slide="prev" data-bs-target="#popup-carousel" type="button">
<span class="carousel-control-prev-icon"></span>
</button>
<button class="carousel-control-next" data-bs-slide="next" data-bs-target="#popup-carousel" type="button">
<span class="carousel-control-next-icon"></span>
</button>
</div>
<div class="d-flex justify-content-center gap-2 mb-3" id="popup-thumbnails"></div>
<select class="form-select mb-3" id="color-select"></select>
<p id="popup-description"></p>
<p><strong id="popup-price"></strong></p>
<button class="btn btn-primary" onclick="addToCartFromPopup()">أضف إلى السلة</button>
<button class="btn btn-secondary mt-2 w-100" onclick="closePopup('product-popup')">إغلاق</button>
</div>
<!-- إتمام الطلب -->
<div class="checkout-popup" id="checkout-popup">
<h5>إتمام الطلب</h5>
<input class="form-control mb-2" id="name" placeholder="الاسم" type="text"/>
<input class="form-control mb-2" id="phone" placeholder="رقم الهاتف" type="text"/>
<select class="form-select mb-2" id="delivery-area" onchange="updateDeliveryFee()">
<option disabled="" selected="" value="">اختر منطقة التوصيل</option>
<option value="area1">المنطقة 1</option>
<option value="area2">المنطقة 2</option>
<option value="area3">المنطقة 3</option>
</select>
<div class="mb-2" id="delivery-fee-message" style="font-weight: bold;"></div>
<input class="form-control mb-2" id="address" placeholder="العنوان" type="text"/>
<!-- <button class="btn btn-sm btn-outline-secondary mb-2" onclick="getUserLocation()">استخدم موقعي الحالي</button> -->
<!-- <div id="location-error">⚠️ لم نتمكن من الحصول على موقعك. تأكد من السماح للموقع في إعدادات المتصفح.</div> -->
<select class="form-select mb-3" id="payment">
<option value="cash">نقداً</option>
<option value="CliQ">CliQ</option>
</select>
<!-- coupon-->
<input class="form-control mb-2" id="coupon-code" placeholder="كود الخصم (إن وجد)" type="text"/>
<button class="btn btn-sm btn-outline-secondary mb-3 w-100" onclick="applyCoupon()">تفعيل الكوبون</button>
<div class="text-success mb-2" id="coupon-message" style="display:none;"></div>
<div class="border p-2 mb-3" id="order-summary" style="background:#f9f9f9;">
<h6 class="fw-bold mb-2">ملخص الطلب:</h6>
<ul class="list-unstyled mb-1" id="summary-items" style="max-height: 150px; overflow-y:auto;"></ul>
<div class="fw-bold">المجموع: <span id="summary-total">0 د.أ</span></div>
</div>
<button class="btn btn-success w-100" onclick="submitOrder()">تأكيد الطلب</button>
<button class="btn btn-secondary mt-2 w-100" onclick="closePopup('checkout-popup')">إلغاء</button>
</div>
<!-- الفوتر -->
<footer class="bg-light text-center mt-5 py-4">
<div>
<a class="navbar-brand" href="#"><img alt="الشعار" src="assets/img/logo.png" style="max-width: 150px;"/></a>
<br/>
    © 2025 جميع الحقوق محفوظة<br/>
    البريد الإلكتروني: info@brand.com<br/>
    الهاتف: +962-7-1234-5678
  </div>
</footer> 
 <script src="assets/js/config.js"></script>

<script>
  let products = [];
  fetch(CONFIG.PRODUCTS_API_URL)
    .then(res => res.json())
    .then(data => {
      products = data.map(item => ({
        id: Number(item.id || 0),
        name: item.name || 'منتج بدون اسم',
        category: item.category || 'other',
        price: Number(item.price || 0),
        oldPrice: Number(item.oldPrice || 0),
        shortDesc: item.shortDesc || '',
        description: item.description || '',
        images: (item.images || '').split(',').map(s => s.trim()).filter(s => s),
        colors: (item.colors || '').split(',').map(c => c.trim()).filter(c => c)
      }));
      displayProducts();
    });

  function refreshProducts() {
    fetch(CONFIG.PRODUCTS_API_URL)
      .then(res => res.json())
      .then(data => {
        products = data.map(item => ({
          id: Number(item.id || 0),
          name: item.name || 'منتج بدون اسم',
          category: item.category || 'other',
          price: Number(item.price || 0),
          oldPrice: Number(item.oldPrice || 0),
          shortDesc: item.shortDesc || '',
          description: item.description || '',
          images: (item.images || '').split(',').map(s => s.trim()).filter(s => s),
          colors: (item.colors || '').split(',').map(c => c.trim()).filter(c => c)
        }));
        displayProducts();
      });
  }

  // ✅ تحميل السلة من localStorage أو البدء بسلة فارغة
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  let currentProduct = null;
  let currentFilter = 'all';

  function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function displayProducts() {
    const container = document.getElementById('products');
    container.innerHTML = '';
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = products.filter(p => (currentFilter === 'all' || p.category === currentFilter) && p.name.toLowerCase().includes(search));
    filtered.forEach(product => {
      const card = document.createElement('div');
      card.className = 'col-6 col-md-3';

      card.innerHTML = `
        <div class="card product-card">
          <img src="${product.images[0]}" class="card-img-top" alt="${product.name}">
          <div class="card-body">
            <h5 class="card-title">${product.name}</h5>
            <p class="card-text">${product.shortDesc}</p>
            <p class="card-text text-danger fw-bold">$${product.price} <span class="text-muted text-decoration-line-through">$${product.oldPrice}</span></p>
            <button class="btn btn-sm btn-outline-primary" onclick='addToCart(${product.id})'>أضف إلى السلة</button>
            <button class="btn btn-sm btn-link" onclick='showProductPopup(${product.id})'>عرض التفاصيل</button>
          </div>
        </div>`;
      container.appendChild(card);
    });
  }

  function setFilter(filter) {
    currentFilter = filter;
    displayProducts();
  }

  function addToCart(id, color = null) {
    const product = products.find(p => p.id === id);
    const existing = cart.find(item => item.id === product.id && item.color === color);

    if (existing) {
      existing.quantity++;
    } else {
      cart.push({ ...product, quantity: 1, color });
    }
    updateCart();
    saveCart(); // ✅ حفظ التغير في السلة
  }

  function updateCart() {
    document.getElementById('cart-count').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    const list = document.getElementById('cart-items');
    list.innerHTML = '';

    cart.forEach((item, index) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center justify-content-between';
      li.innerHTML = `
        <img src="${item.images[0]}" style="width: 40px; height: 40px; object-fit: cover; margin-left: 10px;">
        <span class="flex-grow-1">(${item.id}) ${item.name}${item.color ? ' - ' + item.color : ''}<br> × ${item.quantity} </span>
        <span class="me-2">$${item.price * item.quantity}</span>
        <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">×</button>`;
      list.appendChild(li);
    });

    let totalPrice = 0;
    cart.forEach(item => {
      totalPrice += item.price * item.quantity;
    });
    document.getElementById('cart-total').textContent = totalPrice + ' د.أ';

    if (discountPercent > 0) {
  const discount = totalPrice * (discountPercent / 100);
  const finalTotal = totalPrice - discount;

  document.getElementById('cart-total').innerHTML = `
    <div><s>${totalPrice.toFixed(2)} د.أ</s></div>
    <div class="text-success">${finalTotal.toFixed(2)} د.أ بعد الخصم</div>`;
} else {
  document.getElementById('cart-total').textContent = totalPrice.toFixed(2) + ' د.أ';
}
  }

  function removeFromCart(index) {
    if (cart[index].quantity > 1) {
      cart[index].quantity--;
    } else {
      cart.splice(index, 1);
    }
    updateCart();
    saveCart(); // ✅ حفظ التغير في السلة
  }

  function toggleCartPopup() {
    const popup = document.getElementById('cart-popup');
    popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
  }

  function showProductPopup(id) {
    currentProduct = products.find(p => p.id === id);

    document.getElementById('popup-title').textContent = currentProduct.name;
    document.getElementById('popup-description').textContent = currentProduct.description;
    document.getElementById('popup-price').textContent = `$${currentProduct.price} (كان $${currentProduct.oldPrice})`;

    const carouselInner = document.getElementById('popup-carousel-inner');
    const thumbnails = document.getElementById('popup-thumbnails');
    carouselInner.innerHTML = '';
    thumbnails.innerHTML = '';

    currentProduct.images.forEach((img, idx) => {
      const item = document.createElement('div');
      item.className = `carousel-item ${idx === 0 ? 'active' : ''}`;
      item.innerHTML = `<img src="${img}" class="d-block w-100" alt="${currentProduct.name}">`;
      carouselInner.appendChild(item);

      const thumb = document.createElement('img');
      thumb.src = img;
      thumb.className = 'img-thumbnail';
      thumb.style.width = '70px';
      thumb.style.cursor = 'pointer';
      thumb.onclick = () => {
        const carousel = new bootstrap.Carousel(document.getElementById('popup-carousel'));
        carousel.to(idx);
      };
      thumbnails.appendChild(thumb);
    });

    const colorSelect = document.getElementById('color-select');
    colorSelect.innerHTML = '';
    if (currentProduct.colors && currentProduct.colors.length > 0) {
      currentProduct.colors.forEach(color => {
        const option = document.createElement('option');
        option.value = color;
        option.textContent = color;
        colorSelect.appendChild(option);
      });
      colorSelect.style.display = 'block';
    } else {
      colorSelect.style.display = 'none';
    }

    document.getElementById('product-popup').style.display = 'block';
  }

  function addToCartFromPopup() {
    if (currentProduct) {
      const selectedColor = document.getElementById('color-select').value || null;
      addToCart(currentProduct.id, selectedColor);
      closePopup('product-popup');
    }
  }

  function closePopup(id) {
    document.getElementById(id).style.display = 'none';
  }

  function showCheckoutPopup() {
    closePopup('cart-popup');
    document.getElementById('checkout-popup').style.display = 'block';
    updateOrderSummary(); // ✅ تحديث الملخص
  }

  function updateOrderSummary() {
  const list = document.getElementById('summary-items');
  const totalEl = document.getElementById('summary-total');
  list.innerHTML = '';

  let totalBefore = 0;
  cart.forEach(item => {
    const li = document.createElement('li');
    li.textContent = `(${item.id}) ${item.name}${item.color ? ' - ' + item.color : ''} × ${item.quantity}`;
    list.appendChild(li);
    totalBefore += item.price * item.quantity;
  });

  const discountAmount = discountPercent > 0 ? totalBefore * (discountPercent / 100) : 0;
  const totalAfterDiscount = totalBefore - discountAmount;
  const totalFinal = totalAfterDiscount + deliveryFee;

  totalEl.innerHTML = `
    ${discountPercent > 0 ? `<div>المجموع قبل الخصم: <s>${totalBefore.toFixed(2)} د.أ</s></div>
    <div>قيمة الخصم (${discountPercent}%): -${discountAmount.toFixed(2)} د.أ</div>` : ''}
    <div>رسوم التوصيل: ${deliveryFee.toFixed(2)} د.أ</div>
    <div class="text-success fw-bold">المجموع النهائي: ${totalFinal.toFixed(2)} د.أ</div>
  `;
}

const deliveryFees = {
  area1: 5,  // رسوم التوصيل 5 د.أ للمنطقة 1
  area2: 10, // رسوم التوصيل 10 د.أ للمنطقة 2
  area3: 15  // رسوم التوصيل 15 د.أ للمنطقة 3
};
let deliveryFee = 0;

function updateDeliveryFee() {
  const areaSelect = document.getElementById('delivery-area');
  const selectedArea = areaSelect.value;
  const feeMessage = document.getElementById('delivery-fee-message');

  if (deliveryFees[selectedArea] !== undefined) {
    deliveryFee = deliveryFees[selectedArea];
    feeMessage.textContent = `رسوم التوصيل: ${deliveryFee.toFixed(2)} د.أ`;
  } else {
    deliveryFee = 0;
    feeMessage.textContent = '';
  }
  updateOrderSummary();
  updateCart();  // لتحديث المجموع في السلة إذا تعرض هناك
}


  const coupons = {
  "SAVE10": 10, // خصم 10%
  "OFF20": 20, // خصم 20%
  "VIP30": 30  // خصم 30%
};

let appliedCoupon = null;
let discountPercent = 0;

function applyCoupon() {
  const code = document.getElementById('coupon-code').value.trim().toUpperCase();
  const message = document.getElementById('coupon-message');

  if (coupons[code]) {
    appliedCoupon = code;
    discountPercent = coupons[code];
    message.textContent = `تم تطبيق كوبون الخصم (${discountPercent}%) بنجاح ✅`;
    message.style.color = 'green';
    message.style.display = 'block';
    document.getElementById('coupon-code').disabled = true;

    updateCart();
    updateOrderSummary();
  } else {
    appliedCoupon = null;
    discountPercent = 0;
    message.textContent = '❌ الكود غير صالح';
    message.style.color = 'red';
    message.style.display = 'block';
    updateCart();
  }
}



  function submitOrder() {
  const name = document.getElementById('name').value;
  const phone = document.getElementById('phone').value;
  const address = document.getElementById('address').value;
  const payment = document.getElementById('payment').value;
  const areaSelect = document.getElementById('delivery-area');
  const selectedArea = areaSelect.options[areaSelect.selectedIndex]?.text || '';

  if (name && phone && address && payment && selectedArea) {
    const orderItems = cart.map(i => `- (${i.id}) ${i.name}${i.color ? ' - ' + i.color : ''} × ${i.quantity}`).join('\n');
    const totalBefore = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
    const discountAmount = discountPercent > 0 ? totalBefore * discountPercent / 100 : 0;
    const totalAfter = totalBefore - discountAmount + deliveryFee;

   const framedMessage = `
╔═══════════════ طلب شراء ═══════════════╗

${orderItems}

${appliedCoupon ? `كود الخصم: ${appliedCoupon} (${discountPercent}%)\n` : ''}

رسوم التوصيل: ${deliveryFee.toFixed(2)} د.أ
المجموع النهائي: ${totalAfter.toFixed(2)} د.أ

المنطقة: ${selectedArea}

الهاتف: ${phone}
العنوان: ${address}
الدفع: ${payment}

╚════════════════════════════════════════╝
  `;

const whatsappURL = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodeURIComponent(framedMessage)}`;
  window.open(whatsappURL, '_blank');

    cart.length = 0;
    appliedCoupon = null;
    discountPercent = 0;
    deliveryFee = 0;

    document.getElementById('coupon-code').value = '';
    document.getElementById('coupon-code').disabled = false;
    document.getElementById('coupon-message').style.display = 'none';
    document.getElementById('delivery-area').selectedIndex = 0;
    document.getElementById('delivery-fee-message').textContent = '';

    updateCart();
    saveCart();
    closePopup('checkout-popup');

 fetch(CONFIG.ORDERS_API_URL, {
  method: "POST",
  body: JSON.stringify({
    name,
    phone,
    area: selectedArea,
    address,
    payment,
    items: orderItems,
    deliveryFee: deliveryFee.toFixed(2),
    coupon: appliedCoupon || '',
    discountAmount: discountAmount.toFixed(2),
     total: totalAfter.toFixed(2)
  }),
 
});

  } else {
    alert('يرجى تعبئة جميع الحقول واختيار المنطقة.');
  }
}

  displayProducts();
  updateCart(); // ✅ تأكد من تحميل السلة بعد فتح الصفحة
  setInterval(refreshProducts, 60000); // يحدث كل دقيقة
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
